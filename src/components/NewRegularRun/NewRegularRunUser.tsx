import React, { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import customAxios from "../../apis/customAxios";
import RegularRunlogo from "../../assets/regularRunMark.svg";
import people from "../../assets/FlashRunDetail/people.svg";
import place from "../../assets/FlashRunDetail/place.svg";
import time from "../../assets/FlashRunDetail/time.svg";
import BackBtnimg from "../../assets/BackBtn.svg";
import pacermark from "../../assets/pacer-mark.svg";
import flashrunimage from "../../assets/Run-img/flashrunimage.jpg";

import TabButton from "./TapButton";
import AttendanceList from "./AttendanceList";
import CommentSection from "../common/CommentSection";
import PacerCard from "./PacerCard";
import { Swiper, SwiperSlide } from "swiper/react";
import { Pagination } from "swiper/modules";
import "swiper/css";
import "swiper/css/pagination";
import { motion } from "framer-motion";

import checkedicon from "../../assets/checkedicon.svg"

import TabNavigationUI_detail from "../TabNavigationUI_detail";


interface FlashRunUserData {
  postId?: string;
}

const NewRegularRunUser: React.FC<FlashRunUserData> = ({ postId }) => {
  const navigate = useNavigate();
  const handleBack = () => navigate(-1);

  const [activeTab, setActiveTab] = useState<"ÏÜåÍ∞ú" | "Î™ÖÎã®">("ÏÜåÍ∞ú");
  const [title, setTitle] = useState("");
  const [location, setLocation] = useState("");
  const [date, setDate] = useState("");
  const [content, setContent] = useState("");
  const [postImageUrl, setPostImageUrl] = useState<string | null>(null);
  const [participants, setParticipants] = useState<any[]>([]);
  const [participantsNum, setParticipantsNum] = useState(0);
  const [pacers, setPacers] = useState<any[]>([]);
  const [attachmentUrls, setAttachmentUrls] = useState<string[]>([]);
  const [userInfo, setUserInfo] = useState({
    userId: 0,
    userName: "",
    userProfileImg: "",
    userRole: "",
  });
  const [postCreatorName, setPostCreatorName] = useState("");
  const [postCreatorImg, setPostCreatorImg] = useState<string | null>(null);
  const [refreshComments, setRefreshComments] = useState(false);
  const [userStatus, setUserStatus] = useState("");

  const [buttonText, setButtonText] = useState("Ï∞∏Ïó¨ÌïòÍ∏∞"); // Í∏∞Î≥∏Í∞íÎßå

  const [isGroupModalOpen, setIsGroupModalOpen] = useState(false);
  const [groupList, setGroupList] = useState<{ group: string; pace: string }[]>([]);
  const [selectedGroup, setSelectedGroup] = useState<string>("");
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [code, setCode] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [groupedParticipants, setGroupedParticipants] = useState<any[]>([]);
  const [postStatus, setPostStatus] = useState("");
  const [buttonRefreshKey, setButtonRefreshKey] = useState(0);
  const [refreshTrigger, setRefreshTrigger] = useState(0);

  const [showMenu, setShowMenu] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);
  const dotButtonRef = useRef<HTMLDivElement>(null);

  const [isEditMode, setIsEditMode] = useState(false);
  const [editedAttendance, setEditedAttendance] = useState<{ [userId: number]: boolean }>({});

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (
        menuRef.current &&
        !menuRef.current.contains(e.target as Node) &&
        dotButtonRef.current &&
        !dotButtonRef.current.contains(e.target as Node)
      ) {
        setShowMenu(false);
      }
    };
    if (showMenu) document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [showMenu]);

  useEffect(() => {
    const fetchPostData = async () => {
      try {
        const token = JSON.parse(localStorage.getItem("accessToken") || "null");
        const response = await customAxios.get(`/run/regular/post/${postId}`, {
          headers: { Authorization: `${token}` },
        });

        if (response.data.isSuccess) {
          const result = response.data.result;

          // Í∏∞Ï°¥ ÏÉÅÌÉú ÏÑ∏ÌåÖ
          setTitle(result.title);
          setLocation(result.location);
          setDate(result.date);
          setContent(result.content);
          setPostImageUrl(result.postImageUrl);
          setParticipants(result.participants || []);
          setParticipantsNum(result.participantsNum || 0);
          setPacers(result.pacers || []);
          setAttachmentUrls(result.attachmentUrls || []);
          setUserInfo({
            userId: result.userInfo?.userId || 0,
            userName: result.userInfo?.userName || "",
            userProfileImg: result.userInfo?.userProfileImg || "",
            userRole: result.userInfo?.userRole || "",
          });
          setPostCreatorName(result.postCreatorInfo.userName);
          setPostCreatorImg(result.postCreatorInfo.userProfileImg || null);
          setGroupedParticipants(result.groupedParticipants || []);
          setPostStatus(result.postStatus);

          const myInfo = result.userInfo;
          const foundGroup = result.groupedParticipants?.find((group) =>
            group.participants?.some((p: any) => p.userId === myInfo.userId)
          );
          if (foundGroup) {
            setSelectedGroup(foundGroup.group);
            const matchedUser = foundGroup.participants.find(
              (p: any) => p.userId === myInfo.userId
            );
            setUserStatus(matchedUser?.status || "");
            setButtonText(
              matchedUser?.status === "ATTENDED"
                ? "Ï∂úÏÑùÏôÑÎ£å"
                : matchedUser?.status === "PENDING"
                  ? "Ï∂úÏÑùÌïòÍ∏∞"
                  : "Ï∞∏Ïó¨ÌïòÍ∏∞"
            );
            setIsGroupModalOpen(false);
          }
          console.log(result.attachmentUrls); // 1Ïû•Ïù∏ÏßÄ, Ïó¨Îü¨ Ïû•Ïù∏ÏßÄ
        }
      } catch {
        setError("Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®");
      }
    };

    fetchPostData();
  }, [refreshTrigger]);

  const fetchParticipantsInfo = async () => {
    try {
      const token = JSON.parse(localStorage.getItem("accessToken") || "null");
      const response = await customAxios.get(`/run/regular/post/${postId}`, {
        headers: { Authorization: `${token}` },
      });

      if (response.data.isSuccess) {
        const result = response.data.result;
        setParticipants(result.participants || []);
        setParticipantsNum(result.participantsNum || 0);
        setGroupedParticipants(result.groupedParticipants || []);

        console.log("üì¶ Fetched participants:", result.participants);
        console.log("üë• Fetched grouped participants:", result.groupedParticipants);
      }
    } catch (error: any) {
      console.error("‚ùå Ï∞∏Ïó¨/Ï∑®ÏÜå ÏöîÏ≤≠ Ïã§Ìå®:", error);

      if (error?.response?.data) {
        const serverError = error.response.data;
        console.error("üì¶ ÏÑúÎ≤Ñ ÏùëÎãµ ÎÇ¥Ïö©:", serverError);

        setError(serverError.responseMessage || "Ï∞∏Ïó¨ ÏöîÏ≤≠ Ïã§Ìå®");
      } else {
        setError("Ï∞∏Ïó¨ ÏöîÏ≤≠ Ïã§Ìå®");
      }
    }
  };

  useEffect(() => {
    fetchParticipantsInfo();
  }, [postId]);

  useEffect(() => {
    if (activeTab === "Î™ÖÎã®") {
      fetchParticipantsInfo();
    }
  }, [activeTab]);

  const handleOpenGroupModal = async () => {
    setIsGroupModalOpen(true);
    try {
      const token = JSON.parse(localStorage.getItem("accessToken") || "null");
      const res = await customAxios.get(`/run/regular/post/${postId}/group`, {
        headers: { Authorization: `${token}` },
      });
      if (res.data.isSuccess) setGroupList(res.data.result);
    } catch {
      setError("Í∑∏Î£π Ï°∞Ìöå Ïã§Ìå®");
    }
  };

  const handleJoinConfirm = async () => {
    const isCancel = selectedGroup === "";

    try {
      const token = JSON.parse(localStorage.getItem("accessToken") || "null");
      const res = await customAxios.patch(
        `/run/regular/post/${postId}/join${!isCancel ? `?group=${selectedGroup}` : ""}`,
        {},
        { headers: { Authorization: `${token}` } }
      );

      if (res.data.isSuccess) {
        if (isCancel) {
          //  Ï∞∏Ïó¨ Ï∑®ÏÜå Ï≤òÎ¶¨
          setUserStatus("");
          setButtonText("Ï∞∏Ïó¨ÌïòÍ∏∞");
          setSelectedGroup("");
          setIsGroupModalOpen(false);
          return;
        }

        //  Í∑∏Î£π Ï∞∏Ïó¨ ÏÑ±Í≥µ
        setUserStatus("PENDING"); // Î¨¥Ï°∞Í±¥ ÏßÅÏ†ë ÏÑ∏ÌåÖ
        setButtonText("Ï∂úÏÑùÌïòÍ∏∞");
        setSelectedGroup(selectedGroup); // ÏÑ†ÌÉùÌñàÎçò Í∑∏Î£π
        setIsGroupModalOpen(false);

      } else {
        setError(res.data.responseMessage);
      }
    } catch (error: any) {
      console.error("‚ùå Ï∞∏Ïó¨/Ï∑®ÏÜå ÏöîÏ≤≠ Ïã§Ìå®:", error);
      if (error?.response?.data) {
        setError(error.response.data.responseMessage || "Ï∞∏Ïó¨ ÏöîÏ≤≠ Ïã§Ìå®");
      } else {
        setError("Ï∞∏Ïó¨ ÏöîÏ≤≠ Ïã§Ìå®");
      }
    }
  };

  // Î≥ÄÍ≤ΩÎêú handleAttendanceClick Ìï®Ïàò:
  const handleAttendanceClick = async () => {
    if (!code) return setError("Ï∂úÏÑù ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    try {
      const token = JSON.parse(localStorage.getItem("accessToken") || "null");
      const response = await customAxios.post(
        `/run/regular/post/${postId}/attend`,
        { code },
        { headers: { Authorization: `${token}` } }
      );
      if (response.data.isSuccess) {
        setUserStatus("ATTENDED");
        setButtonText("Ï∂úÏÑùÏôÑÎ£å");
        setIsModalOpen(false);
        setError(null);
      } else {
        setError(response.data.responseMessage);
      }
    } catch {
      setError("Ï∂úÏÑù ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    }
  };

  const formatDateTime = (iso: string) => {
    const utcDate = new Date(iso);
    const kstDate = new Date(utcDate.getTime() + 9 * 60 * 60 * 1000);
    return `${kstDate.getMonth() + 1}Ïõî ${kstDate.getDate()}Ïùº ${kstDate
      .getHours()
      .toString()
      .padStart(2, "0")}:${kstDate.getMinutes().toString().padStart(2, "0")}`;
  };

  const toggleAttendance = (userId: number, originalStatus: string) => {
    setEditedAttendance(prev => {
      const current = userId in prev ? prev[userId] : originalStatus === "ATTENDED";
      return { ...prev, [userId]: !current };
    });
  };

  const handleEditAttempt = () => {
    const now = new Date(); // ÌòÑÏû¨ Î°úÏª¨ ÏãúÍ∞Ñ
    const postDateKST = new Date(new Date(date).getTime() + 9 * 60 * 60 * 1000);


    if (now < postDateKST) {
      alert("ÏïÑÏßÅ Î™ÖÎã® ÏàòÏ†ïÏùÑ Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
      return;
    }
    // Ï∑®ÏÜå Í∏ÄÏùÄ ÎàÑÍµ¨ÎèÑ Ìé∏Ïßë Î∂àÍ∞Ä
    if (postStatus === "CANCELED") {
      alert("Ï∑®ÏÜåÎêú Îü¨ÎãùÏùÄ Î™ÖÎã®ÏùÑ ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
      return;
    }

    // ADMIN ÏùÄ CLOSED Ïó¨ÎèÑ Ìé∏Ïßë ÌóàÏö©
    if (userInfo.userRole === "ADMIN") {
      setIsEditMode(true);
      return;
    }

    // ÏùºÎ∞ò ÏûëÏÑ±Ïûê/Ïú†Ï†ÄÎäî Í∏∞Ï°¥ Ï†ïÏ±Ö Ïú†ÏßÄ
    if (postStatus === "CLOSED") {
      alert("Ï∂úÏÑùÏù¥ Ï¢ÖÎ£åÎêòÏñ¥ Î™ÖÎã® ÏàòÏ†ïÏù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.");
      return;
    }


    setIsEditMode(true);
  };

  const saveAttendanceChanges = async () => {
    const token = JSON.parse(localStorage.getItem("accessToken") || "null");
    const payload = Object.entries(editedAttendance).map(([userId, isAttend]) => ({
      userId: Number(userId),
      isAttend,
    }));

    try {
      const endpoint =
        postStatus === "CLOSED" && userInfo.userRole === "ADMIN"
          ? `/run/regular/post/${postId}/fix-attendance`      // ‚úÖ Ï¢ÖÎ£å ÌõÑ ADMIN Ï†ÑÏö©
          : `/run/regular/post/${postId}/manual-attendance`;  // Í∏∞Ï°¥ Í≤ΩÎ°ú

      await customAxios.patch(endpoint, payload, {
        headers: { Authorization: `${token}` },
      });

      alert("Ï∂úÏÑù Ï†ïÎ≥¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
      setIsEditMode(false);
      setEditedAttendance({});
      await fetchParticipantsInfo(); // Î™©Î°ù ÏµúÏã†Ìôî
    } catch {
      alert("Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    }
  };

  return (
    <div className="w-full min-h-screen bg-white overflow-y-auto overflow-x-hidden">
      <div className="flex flex-col items-center text-center justify-center w-full max-w-[430px] mx-auto">
        <div className="relative flex bg-kuDarkGreen w-full h-[56px] text-white text-xl font-semibold justify-center items-center">
          <img
            src={BackBtnimg}
            className="absolute left-[24px] cursor-pointer"
            onClick={handleBack}
          />
          Ï†ïÍ∑úÎü∞


          {userInfo.userRole === "ADMIN" && (
            <div
              ref={dotButtonRef}
              className="absolute right-[8px] top-1/2 -translate-y-1/2 p-1 rounded-full hover:bg-white/20 cursor-pointer"
              onClick={(e) => {
                e.stopPropagation();
                setShowMenu((prev) => !prev);
              }}
            >
              <div className="w-6 h-6 flex flex-col justify-center items-center gap-y-[4px]">
                {[...Array(3)].map((_, i) => (
                  <span key={i} className="w-[4px] h-[4px] bg-white rounded-full" />
                ))}
              </div>
            </div>
          )}


          {userInfo.userRole === "ADMIN" && showMenu && (
            <motion.div
              ref={menuRef}
              initial="hidden"
              animate="visible"
              exit="exit"
              variants={{ hidden: {}, visible: {}, exit: {} }}
              className="absolute top-[50px] right-[16px] z-20 flex flex-col gap-y-2"
            >
              <motion.button
                key="ÏÇ≠Ï†úÌïòÍ∏∞"
                initial={{ opacity: 0, y: -10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                transition={{ duration: 0.2 }}
                className="w-[100px] py-2 px-3 rounded-tl-xl rounded-b-xl bg-white shadow-md text-black text-sm"
                onClick={async () => {
                  const confirmDelete = window.confirm("Ï†ïÎßê Í≤åÏãúÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÏÇ≠Ï†ú ÌõÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
                  if (!confirmDelete) return;

                  try {
                    const token = JSON.parse(localStorage.getItem("accessToken") || "null");
                    if (!token) {
                      alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                      return;
                    }


                    const { data } = await customAxios.delete(
                      `/run/regular/post/${postId}`,
                      { headers: { Authorization: `${token}` } }
                    );

                    if (data.isSuccess) {
                      alert("Í≤åÏãúÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                      setShowMenu(false);
                      navigate("/regular");
                    } else {
                      alert(data.responseMessage || "ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                    }
                  } catch (error) {
                    console.error(error);
                    alert("ÏÇ≠Ï†ú ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                  }
                }}
              >
                ÏÇ≠Ï†úÌïòÍ∏∞
              </motion.button>
            </motion.div>
          )}

        </div>

        <div className="relative w-full pb-[90px]">
          <div className="relative w-full h-[250px] overflow-hidden">
            <img
              src={postImageUrl || flashrunimage}
              className={`w-full h-full object-cover ${postStatus === "CANCELED" || postStatus === "CLOSED" ? "brightness-50" : ""}`}
            />
            {(postStatus === "CANCELED" || postStatus === "CLOSED") && (
              <div className="absolute inset-0 flex justify-center items-center bg-opacity-40 bg-black">
                <div className="text-white text-lg font-bold bg-opacity-60 px-4 py-2 rounded">
                  {postStatus === "CANCELED" ? "Ï∑®ÏÜåÎêú Îü¨ÎãùÏûÖÎãàÎã§." : "ÎßàÍ∞êÎêú Îü¨ÎãùÏûÖÎãàÎã§."}
                </div>
              </div>
            )}
          </div>

          <div className="absolute top-[230px] w-full px-5 rounded-t-[20px] bg-white">
            <div className="flex flex-col items-center mt-[14px]">
              <object data={RegularRunlogo} className="w-[60px] h-[24px]" />
              <div className="text-lg font-semibold mt-2 text-[24px]">{title}</div>
            </div>
            <div className="flex flex-col items-start w-full max-w-[360px] mt-5">
              <div className="flex items-center my-1.5">
                <object data={place} className="w-[24px] h-[24px] mr-2" />
                <span>{location}</span>
              </div>
              <div className="flex items-center my-1.5">
                <object data={time} className="w-[24px] h-[24px] mr-2" />
                <span>{formatDateTime(date)}</span>
              </div>
              <div className="flex items-center my-1.5">
                <object data={people} className="w-[24px] h-[24px] mr-2" />
                <span className="font-bold text-kuDarkGreen">{participantsNum}</span>
              </div>
            </div>
          </div>
        </div>

        <div className="mt-[70px]">
          <TabButton leftLabel="ÏÜåÍ∞ú" rightLabel="Î™ÖÎã®" onTabChange={setActiveTab} />
        </div>

        {activeTab === "ÏÜåÍ∞ú" && (
          <>
            <div className="flex items-start text-left w-full mt-[24px] my-2 max-w-[349px]">
              <img src={pacermark} />
              <div className="m-1">PACER</div>
            </div>
            <PacerCard pacers={pacers} />
            {attachmentUrls.length > 0 && (
              <div className="mt-5 w-[327px]">
                <div className="text-left text-[16px] mb-[16px]">ÏΩîÏä§ ÏÇ¨ÏßÑ</div>
                <Swiper
                  pagination={{ clickable: true }}
                  modules={[Pagination]}
                  spaceBetween={10}
                  slidesPerView={1}
                >
                  {attachmentUrls.map((url, index) => (
                    <SwiperSlide key={index}>
                      <div className="relative">
                        <div className="w-full h-[300px] overflow-hidden">
                          <img
                            src={url}
                            alt={`ÏΩîÏä§ ÏÇ¨ÏßÑ ${index + 1}`}
                            className="rounded-lg w-full h-full object-cover"
                          />
                        </div>
                        <div className="absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-full">
                          {index + 1}/{attachmentUrls.length}
                        </div>
                      </div>
                    </SwiperSlide>
                  ))}
                </Swiper>
              </div>
            )}
            <div className="flex flex-col mt-[24px] items-start text-left w-full max-w-[327px]">
              ÏÑ∏Î∂Ä ÎÇ¥Ïö©
            </div>
            <div className="mt-[12px] w-[327px] border border-[#ECEBE4] rounded-lg p-4">
              <div className="flex items-center gap-2 mb-2">
                {postCreatorImg ? (
                  <img
                    src={postCreatorImg}
                    alt="ÌîÑÎ°úÌïÑ"
                    className="w-8 h-8 rounded-full object-cover"
                  />
                ) : (
                  <div className="w-8 h-8 rounded-full bg-[#844E4E] text-white text-xs flex items-center justify-center font-bold">
                    {postCreatorName.charAt(0)}
                  </div>
                )}
                <span className="text-sm font-medium text-black">{postCreatorName}</span>
              </div>
              <div className="text-black p-3 text-sm text-left whitespace-pre-wrap">
                {content}
              </div>
            </div>
          </>
        )}

        {activeTab === "Î™ÖÎã®" && (
          <AttendanceList
            key={JSON.stringify(groupedParticipants)}
            groupedParticipants={groupedParticipants}
            // üîΩ Ìé∏Ïßë Î™®Îìú Í¥ÄÎ†® props Ï†ÑÎã¨
            isEditMode={isEditMode}
            editedAttendance={editedAttendance}
            toggleAttendance={toggleAttendance}
            onSaveAttendance={saveAttendanceChanges}
            onToggleEditMode={handleEditAttempt}
            // ÌëúÏãúÏö©
            userInfoName={userInfo.userName}
            postCreatorName={postCreatorName}
            // üîΩ ADMINÏù¥Î©¥ Î≤ÑÌäº ÎÖ∏Ï∂ú
            canEdit={userInfo.userRole === "ADMIN"}
          />
        )}

        <CommentSection postId={postId!} postType="regular" userInfo={userInfo} refreshTrigger={refreshComments} />

        {/* Ï∞∏Ïó¨ ÏÉÅÌÉúÏóê Îî∞Î•∏ Î≤ÑÌäº Î†åÎçîÎßÅ */}

        <div key={buttonRefreshKey} className="mb-[100px]">
          {(postStatus === "CANCELED" || postStatus === "CLOSED") ? (


            <div className="w-[327px] h-14 rounded-lg bg-[#ECEBE4] text-[#757575] font-bold mt-6 flex justify-center items-center cursor-not-allowed">
              Î™®Ïßë Ï¢ÖÎ£å
            </div>
          ) : userStatus === "ATTENDED" ? (
            <div className="w-[327px] h-14 rounded-lg bg-[#ECEBE4] text-[#757575] font-bold mt-6 flex justify-center items-center cursor-not-allowed">
              Ï∂úÏÑùÏôÑÎ£å
            </div>
          ) : userStatus === "PENDING" ? (
            <>
              {selectedGroup && (
                <div className="text-sm text-left text-kuDarkGray w-full max-w-[327px] mt-4 pl-6">
                  ÎÇ¥Í∞Ä ÏÑ†ÌÉùÌïú Í∑∏Î£π : <span className="font-semibold">{selectedGroup}</span>
                </div>
              )}
              <div className="flex gap-2 mt-[8px] mb-6">
                <button
                  className="w-[164px] h-[52px] font-bold rounded-lg text-white bg-kuGreen"
                  onClick={handleOpenGroupModal}
                >
                  Í∑∏Î£π ÏàòÏ†ï
                </button>
                <button
                  className="w-[164px] h-[52px] rounded-lg font-bold bg-kuDarkGreen text-white"
                  onClick={() => setIsModalOpen(true)}
                >
                  Ï∂úÏÑùÌïòÍ∏∞
                </button>
              </div>
            </>
          ) : (
            <button
              className="w-[327px] h-14 rounded-lg bg-kuGreen text-white font-bold mt-6 mb-6"
              onClick={handleOpenGroupModal}
            >
              Ï∞∏Ïó¨ÌïòÍ∏∞
            </button>
          )}
        </div>

        {isGroupModalOpen && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-10">
            <div className="bg-white p-6 rounded-lg w-[300px] max-w-[90%] text-center relative shadow-lg">
              <button
                className="absolute top-[2px] right-2.5 text-2xl cursor-pointer w-[16px] h-[16px]"
                onClick={() => setIsGroupModalOpen(false)}
              >
                √ó
              </button>
              <h2 className="text-[16px] mb-4">Ï†ïÍ∑úÎü∞ Í∑∏Î£πÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</h2>

              {/* Í∑∏Î£π ÏÑ†ÌÉù ÏòµÏÖò */}
              <div className="flex justify-center">
                <div
                  className="flex flex-col gap-3 max-h-[500px] overflow-y-auto w-full"
                  style={{ paddingRight: "8px", marginRight: "-8px" }}
                >
                  {groupList.map((group, index) => {
                    const isSelected = selectedGroup === group.group;

                    const handleSelect = () => {
                      if (isSelected) {
                        setSelectedGroup(""); // Îã§Ïãú ÎàÑÎ•¥Î©¥ Ìï¥Ï†ú
                      } else {
                        setSelectedGroup(group.group); // ÏÑ†ÌÉù
                      }
                    };

                    return (
                      <button
                        key={index}
                        className={`rounded-lg border flex items-center justify-between w-[230px] h-[48px] ${isSelected ? "bg-[#F3F8E8]" : "bg-gray-100 hover:bg-gray-200"
                          }`}
                        onClick={handleSelect}
                      >
                        {/* ÏôºÏ™Ω: Í∑∏Î£πÎ™Ö | ÌéòÏù¥Ïä§ */}
                        <div className="flex items-center text-left">
                          <span
                            className={`my-[16px] ml-[16px] font-bold text-base ${isSelected ? "text-black" : "text-gray-400"
                              }`}
                          >
                            {group.group}
                          </span>
                          <div className="w-px h-[42px] ml-[16px] bg-gray-400" />
                          <span
                            className={`text-[16px] font-semibold ml-[10px] ${isSelected ? "text-kuDarkGreen" : "text-gray-400"
                              }`}
                          >
                            {group.pace}
                          </span>
                        </div>

                        {/* Ïò§Î•∏Ï™Ω Ï≤¥ÌÅ¨ ÏïÑÏù¥ÏΩò */}
                        {isSelected && (
                          <img
                            src={checkedicon}
                            alt="checked"
                            className="w-[24px] h-[24px] mr-[16px]"
                          />
                        )}
                      </button>
                    );
                  })}
                </div>
              </div>
              {/* ÌôïÏù∏ Î≤ÑÌäº */}
              <button
                className="mt-5 w-full py-3 bg-kuDarkGreen text-white rounded-lg"
                onClick={handleJoinConfirm}
              >
                ÌôïÏù∏
              </button>

              {/* ÏóêÎü¨ Î©îÏãúÏßÄ */}
              {error && <div className="text-red-500 mt-2 text-sm">{error}</div>}
            </div>
          </div>
        )}

        {/* // Ï∂úÏÑù Î™®Îã¨ Íµ¨Ï°∞ */}
        {isModalOpen && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-10">
            <div className="bg-white p-5 rounded-lg w-[280px] text-center relative">
              <button
                className="absolute top-2.5 right-2.5 text-2xl cursor-pointer"
                onClick={() => setIsModalOpen(false)}
              >
                √ó
              </button>
              <h2 className="text-lg font-semibold">Ï∞∏Ïó¨ ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</h2>
              <input
                type="text"
                className="w-full p-2 border-b border-gray-300 text-center text-lg mt-5"
                value={code}
                onChange={(e) => setCode(e.target.value)}
              />
              <button
                className="w-full py-3 rounded-lg bg-[#366943] text-white text-lg mt-5"
                onClick={handleAttendanceClick}
              >
                ÌôïÏù∏
              </button>
              {error && <div className="text-red-500 mt-2">{error}</div>}
            </div>
          </div>
        )}
      </div>
      <TabNavigationUI_detail />
    </div>
  );
};

export default NewRegularRunUser;
